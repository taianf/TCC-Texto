\COM
 Resultados mais detalhados serão apresentados no capítulo
\ref{cap:implementacao}.
\MOC



\section{Estudou experimental)}
\label{cap:experimentos}

\section{Introdução}
\label{sec:introImp}

Nesta seção, apresentar-se-á um estudo comparativo das quatro plataformas
apresentados no capítulo \ref{capSOTR}. Os experimentos realizados não tem
por objetivo de ser exaustivos. Eles apenas foram utilizados para entender
o comportamento temporal dos diferentes sistemas, tendo como foco principal
as latências de interrupção e as latências de escalonamento relacionadas 
a camada de rede.

bla bla bla...


\section{Medidas de latências}
\label{sec:medLat}

Na seção \ref{sec:latIRQ} do capítulo \ref{cap:SOTR}, o problema da medida das
latências de interrupção foi brevemente apresentado. Uma das dificuldade apontada
foi esta da medição do instante exata no qual uma determinada interrupção acontece
num certo hardware. Tendo como objetivo a comparação das plataformas Linux, Linux
PREEMPT-RT, RTAI e Xenomai, adotou-se uma metodologia experimental simples,
inspirada de \cite{Proctor01}, que apesar de ser exclusivamente baseada em medidas
do relógio interno do computador, permitiu obter resultados significativos tanto quantitativa
quanto qualitativamente.

\subsection{O dispositivo experimental}
\label{sec:dispExp}

O dispositivo experimental utilizou a porta paralela, conectando um dos pinos
habilitados para escrita, presentemente o pino 9, ao pino 10 de interrupção.  A
descrição desta manipulação e de vários exemplos de módulos para escrever na porta
paralela e capturar as interrupções desta mesma porta foram encontrados no excelente
livro \ing{Linux Device Drivers} \cite{Corbet05}.  Para acessar valores de tempo
numa precisão da ordem do $\mu s$, utilizou-se o contador do processador chamado de
\ing{Time Stamp Counter} (TSC)

Concretamente, um módulo especifico ($M$) foi desenvolvido para exportar as
funcionalidades seguintes:

\begin{itemize}
\item Acessar os 64 bits do TSC e gravar o valor na memória.
\item Escrever na porta de entrada e saída 0x378 da porta paralela para gerar
  interrupções de hardware.
\item Criar uma tarefa de tempo real $\tau$ que, possivelmente, executa algum código
  útil. Neste experimento, $\tau$ simplesmente grava o valor do TSC.
\item Requisitar a captura das interrupções na linha 7 associada a porta paralela e
  registrar o tratador de interrupção $T_{pp}$ associado. $T_{pp}$ executa duas operações:
  (1) gravar o TSC; (2) Acordar $\tau$.
\item Implementar um canal de comunicação FIFO assíncrono para transferir os dados
  coletados em modo protegido para o espaço usuário.
\end{itemize}

Parte deste conjunto de funções foi disponibilizado sob forma de \cod{ioctl} para os processos
executando em modo usuário através de um arquivo especial \cod{/dev/M} do sistema de
arquivo. Outra parte é diretamente exportado sob forma de serviços do \kernell
e podem ser acessadas somente por \ing{threads} do \kernell.

As medidas foram realizadas acompanhando o seguinte roteiro.  

\begin{itemize}
\item Após a inserção do módulo $M$ no \kernel, um processo $P$, executando em modo
  usuário, abre o arquivo especial \ing{/dev/M} para poder acessar as funções
  \ing{ioctl} disponibilizadas pelo módulo $M$. $P$ tenta ler o canal FIFO e fica
  bloqueado esperando dados.
\item Um computador remoto envia pacotes Ethernet numa freqüência de 20Hz para a
  estação de medição. No tratador de interrupção $T-{eth}$ da placa de rede (RealTek
  8139), a função de escrita na porta paralela é chamada.
\item No instante $t_1$ no qual $T$ executa a função de escrita no pino 9 da
  porta paralela, o valor do TSC é memorizado na memória do \kernel.
\item O tratador de interrupção $T_{pp}$ da porta paralela é chamada. Ele grava o
  valor $t_2$ do TSC e acorda a tarefa $\tau$.
\item Eventualmente $\tau$ acorda e grava o valor $t_3$ do TSC e escreve o conjunto
  dos valores $t_1, t_2$ e $t_3$ no canal FIFO, antes de se suspender até a próxima
  interrupção na porta paralela.
\item $P$ é eventualmente acordado, e após leitura do canal, escreve os dados num
  arquivo.
\end{itemize}

Este método experimental tem as seguintes limitações. Quando a interrupção da placa
de rede acontece, o processador executa $T_{eth}$ no contexto do processo em
execução.  Depois de ter escrito na porta paralela, $T_{eth}$ retorna, e o
processador percebe imediatamente que uma outra interrupção espere para ser
tratada. Ele portanto executa $T_{pp}$ em seguida, aproximadamente 10 $\mu s$
depois, possivelmente no contexto do mesmo processo que estava ocupando
o processador quando o pacote Ethernet chegou. Em 

 com uma troca de contexto mínima.  
Por outro lado, este modo experimental garante que as interrupções na porta
paralela sejam tratadas no contexto di
de gerar as interrupções no contexto
da chegada de pacote Ethernet é que estes eventos são totalmente assíncronos em 
relação a atividade da estação de medição. 

No entanto, a principal vantagem 

Portanto, se o tempo de latência de
interrupção observado é quase constante, 

Uma alternativa a este modo experimental é utilizar um processo para escrever
na porta paralela, mas neste caso, o processador sempre executaria $T_{pp}$ no
contexto deste processo. 
No entanto, este modo experimental foi preferido ao uso de um processo para escrever
na porta paralela por duas razões 

De fato, escrever no contexto da chegada de um pacote Ethernet 
tem a vantagem de ser  no lugar
do computador remot
antes de um
interrupção, o processador está sempre executando o processo usuário $P$ que acessa
a função de \cod{ioctl} do módulo $M$ para escrever na porta paralela.  Portanto, a
presença de outros processos usuários sobrecarregando o processador não pode
interferir nas medidas. Uma outra limitação provem do tempo de latência da própria
porta paralela, que leva um certo tempo para estabilizar sua saída, na hora da
escrita. No entanto, os resultados obtidos usando esta metodologia podem servir para
medir um valor mínimo do tempo de latência e para comparar diferentes plataformas
operacionais. Além disso, o impacto causado pela presença de outras atividades gerando
interrupções pode ser observado. No caso deste trabalho, a placa de rede foi utilizado
para este efeito.

Observa que para evitar qualquer interferência nas medidas de latência, no caso do
Linux e de \preempt, o conjunto dos valores mensuradas foi salvo na memória e
somente transferido para o sistema de arquivo depois do fim da execução do
experimento. Para as plataformas RTAI e Xenomai, foram utilizados os canais
\cod{RT-FIFO} de tempo real oferecidos pela API de ambas plataformas. A
implementação, sem \ing{lock}, destes canais garante a princípio a ausência de
interferência com a execução das tarefas de tempo real no sistema.
 
No caso das duas plataformas RTAI e Xenomai, medidas complementares da latência de
escalonamento foram realizadas para avaliar a capacidade destas plataformas em
executar operações de transmissão de mensagens Ethernet com garantias
temporais. Para este efeito, o módulo $M$ foi acrescentado da seguinte maneira. Na
sua inserção, ele cria uma tarefa $T$ (\ing{thread} de \kernel) que é acordada pelo
tratador de interrupção da porta paralela. Quando a tarefa $T$ acorda, ela grava o
valor $t_3$ do TSC. Em seguida, $T$ executa a transmissão de um pacote Ethernet de
64 bytes, utilizando a função \hardStartXmit, disponibilizada pelo controlador da
placa de rede.  No instante no qual esta função é chamada, $T$ grava o valor $t_4$
do TSC. O valor da diferencia $t_3 - t_2$ representa portanto a latência de
escalonamento da tarefa $T$ e o valor $t_4 - t_3$, o tempo de execução necessário
para transmitir um pacote na rede.


\begin{sidewaysfigure}
  \centering
  \subfloat[Interrupção - Sem estresse]{%
    \label{fig:kerSem}%
    {\scalebox{0.84}{\input{fig/kerSem}}}}
  \hspace{20pt}%
  \subfloat[][Escalonamento  - Sem estresse]{%
    \label{fig:kerSemSched}%
    {\scalebox{0.84}{\input{fig/kerSemSched}}}}\\%
%   \hspace{14pt}%
  \subfloat[Interrupção - Com estresse]{%
    \label{fig:kerTot}%
    {\scalebox{0.84}{\input{fig/kerTot}}}}
  \hspace{20pt}%
  \subfloat[][Escalonamento  - Com estresse]{%
    \label{fig:kerTotSched}%
    {\scalebox{0.84}{\input{fig/kerTotSched}}}}%

  \caption[Latência de interrupção e de escalonamento do Kernel Linux]{Latência de
    interrupção e de escalonamento do Kernel Linux, versão 2.6.23.9, opção
    \ing{Low-Latency}. As figuras \subref{fig:kerSem} e \subref{fig:kerSemSched}
    representam uma execução sem estresse e as figuras \subref{fig:kerTot} e
    \subref{fig:kerTotSched} representam uma execução com estresse do processador.
    A freqüência de escrita na porta paralela é de $20 Hz$.}
  \label{fig:klight}%
\end{sidewaysfigure}

\begin{sidewaysfigure}
  \centering
  \subfloat[Interrupção - Sem estresse]{%
    \label{fig:preSem}%
    {\scalebox{0.84}{\input{fig/preSem}}}}
  \hspace{20pt}%
  \subfloat[][Escalonamento  - Sem estresse]{%
    \label{fig:preSemSched}%
    {\scalebox{0.84}{\input{fig/preSemSched}}}}\\%
%   \hspace{14pt}%
  \subfloat[Interrupção - Com estresse]{%
    \label{fig:preTot}%
    {\scalebox{0.84}{\input{fig/preTot}}}}
  \hspace{20pt}%
  \subfloat[][Escalonamento  - Com estresse]{%
    \label{fig:preTotSched}%
    {\scalebox{0.84}{\input{fig/preTotSched}}}}%

  \caption[Latência de interrupção e de escalonamento de PREEMPT-RT]{Latência de
    interrupção e de escalonamento do \ing{patch} PREEMPT-RT instalado no \kernel
    Linux, versão 2.6.23.9. As figuras \subref{fig:preSem} e
    \subref{fig:preSemSched} representam uma execução sem estresse e as figuras
    \subref{fig:preTot} e \subref{fig:preTotSched} representam uma execução com
    estresse do processador.  A freqüência de escrita na porta paralela é de $20
    Hz$.}
  \label{fig:preemptExp}%
\end{sidewaysfigure}

\begin{sidewaysfigure}
  \centering
  \subfloat[Interrupção - Sem estresse]{%
    \label{fig:xenSem}%
    {\scalebox{0.84}{\input{fig/xenSem}}}}
  \hspace{20pt}%
  \subfloat[][Escalonamento  - Sem estresse]{%
    \label{fig:xenSemSched}%
    {\scalebox{0.84}{\input{fig/xenSemSched}}}}\\%
%   \hspace{14pt}%
  \subfloat[Interrupção - Com estresse]{%
    \label{fig:xenTot}%
    {\scalebox{0.84}{\input{fig/xenTot}}}}
  \hspace{20pt}%
  \subfloat[][Escalonamento  - Com estresse]{%
    \label{fig:xenTotSched}%
    {\scalebox{0.84}{\input{fig/xenTotSched}}}}%

  \caption[Latência de interrupção e de escalonamento do Xenomai-Linux]{Latência de
    interrupção e de escalonamento do Xenomai 2.4-rc5 instalado no \kernell Linux,
    versão 2.6.19.7. As figuras \subref{fig:xenSem} e \subref{fig:xenSemSched}
    representam uma execução sem estresse e as figuras \subref{fig:xenTot} e
    \subref{fig:xenTotSched} representam uma execução com estresse do processador.
    A freqüência de escrita na porta paralela é de $20 Hz$.}
  \label{fig:xenoExp}%
\end{sidewaysfigure}


\begin{sidewaysfigure}
  \centering
  \subfloat[Interrupção - Sem estresse]{%
    \label{fig:rtaiSem}%
    {\scalebox{0.84}{\input{fig/rtaiSem}}}}
  \hspace{20pt}%
  \subfloat[][Escalonamento  - Sem estresse]{%
    \label{fig:rtaiSemSched}%
    {\scalebox{0.84}{\input{fig/rtaiSemSched}}}}\\%
%   \hspace{14pt}%
  \subfloat[Interrupção - Com estresse]{%
    \label{fig:rtaiTot}%
    {\scalebox{0.84}{\input{fig/rtaiTot}}}}
  \hspace{20pt}%
  \subfloat[][Escalonamento  - Com estresse]{%
    \label{fig:rtaiTotSched}%
    {\scalebox{0.84}{\input{fig/rtaiTotSched}}}}%

  \caption[Latência de interrupção e de escalonamento do RTAI-Linux]{Latência de
    interrupção e de escalonamento do RTAI magma instalado no \kernell Linux, versão
    2.6.19.7.  As figuras \subref{fig:rtaiSem} e \subref{fig:rtaiSemSched}
    representam uma execução sem estresse e as figuras \subref{fig:rtaiTot} e
    \subref{fig:rtaiTotSched} representam uma execução com estresse do processador.
    A freqüência de escrita na porta paralela é de $20 Hz$.}
  \label{fig:rtaiExp}%
\end{sidewaysfigure}



\begin{comment}

\subsection{Modo operacional}
\label{sec:modOp}

Para realizar as medidas de latência de interrupção e de tratamento, o processo $P$
executou escritas no pino 9 da porta paralela com uma freqüência aproximada de $20
Hz$. Já que as medidas não dependem do valor do instante inicial da escrita, esta
freqüência foi obtida utilizando uma chamada a função \cod{sleep} com um argumento
de $50 ms$.  Esta freqüência relativamente baixa foi escolhida para garantir o
processamento completo de todas as operações de medida e o escalonamento eventual de
outros processos entre cada escrita na porta paralela.  No entanto, resultados
quantitativamente idênticos serão mostrados na seção \ref{} para o RTAI e o Xenomai
com uma freqüência de $1000 Hz$.

No caso destas duas plataformas, RTAI e do Xenomai, o foco foi dado a latência de
interrupção associadas ao domínio primário, descrito na seção \ref{sec:adeos}, já
que a proposta do protocolo \doriss é oferecer garantias temporais para tarefas de
tempo real críticas.

Cada um dos cenários de medida durou aproximadamente 70 segundos e foi realizados
usando um ambiente gráfico. No entanto, experimentos em modo \ing{single}, no qual o
número de \ing{thread} de \kernell é mínimo, deram os mesmos resultados
quantitativos. Nos primeiros 10 segundos dos experimentos, o processo $P$ gerou as
interrupções na freqüência de $20 Hz$ sem que nenhum outra atividade interfere.

Entre a décima e a vigésima segunda, um estresse de comunicação foi aplicado ao
sistema via a rede Ethernet durante aproximadamente 10 segundos. O estresse aplicado
utilizou o comando \cod{ssh} da seguinte maneira. Uma máquina remota executou o
comando \ing{shell} \cod{ssh IP "echo \$ITER >> /tmp/stress"}, 60 vezes
consecutivas.  Nesta expressão, $IP$ era o número IP da estação na qual as medidas
eram realizadas e $\$ITER$ era o índice de iteração do laço de execução do
comando. Constatou-se que 60 vezes corespondiam aproximadamente a um tempo de
execução de 10 segundos.

A escolha deste tipo de estresse se justificou por duas razões principais.  Em
primeiro lugar, a placa de rede utiliza a linha de interrupção 18 cuja prioridade é
menor que a prioridade da porta paralela. Portanto, as interrupções geradas nesta
pela placa de rede não deveriam interferir a princípios nas medidas efetuadas.  Em
segundo lugar, já que este trabalho tem por objetivo a implementação de um protocolo
de rede baseado em Ethernet, pude-se avaliar a capacidade das diferentes plataformas
em garantir uma latência determinística no tratamento das interrupções, mesmo na
presença de um estresse de comunicação.

Todos os experimentos foram realizados pelo menos três vezes e selecionou-se
os cenários com as latências maiores no pior caso.

% Este estresse foi criado simplesmente, utilizando uma comunicação UDP do tipo
% cliente-servidor. Para gerar as interrupções no computador no qual as medidas eram
% efetuadas, confi\-gurou-se este como servidor da comunicação UDP. O processo servidor
% foi criado utilizando a API das bibliotecas \cod{pthread} com a prioridade mais
% alta possível. O cliente, instalado numa máquina remota, foi configurado para 
% transmitir pequenos pacotes de 64 \ing{bytes} na freqüência máxima permitida pela
% rede, ou seja, com uma freqüência de quase $200 kHz$ (um pacote a cada $5 \mu s$).
% Desta forma, 200.000 interrupções por segundos aconteciam na placa de rede
% do servidor.

\subsection{Resultados experimentais}
\label{sec:resulExp}

O dispositivo experimental descrito nas seções \ref{sec:dispExp} e \ref{sec:modOp}
foi implementado em computadores Pentium 4 com processadores de 2.4 Ghz e 512 Mb de
memória. Os resultados experimentais são apresentados pelo meio de figuras nas quais
o eixo horizontal representa o tempo variando de 0 a 70 segundos e o eixo vertical
representa a latência de interrupção em $\mu s$ medida a cada escrita na porta
paralela. 

As seguintes configurações das quatro plataformas Linux, PREEMP-RT, RTAI e Xenomai
foram utilizadas. A versão do \kernell de Linux 2.6.19.7 foi utilizada para os
testes do \kernell Linux, de RTAI e de Xenomai \cite{kernel}. Nos três casos,
compilou-se o \kernell Linux com a configuração de preempção habilitada
(\ing{Low-Latency}). Apesar de existir versões do \kernell mais recentes suportadas
por estas três plataformas, RTAI e Xenomai disponibilizavam \ing{patchs} estáveis
para esta versão do \kernell no início deste trabalho, em janeiro de 2007. Já que
estas duas plataformas são baseados no Adeos, como foi visto na descrição da seção
\ref{sec:adeos}, suas propriedades temporais não dependem, a princípio, do \kernel
Linux. Considerou-se então desnecessário atualizar a versão do \kernell. No entanto,
utilizou-se as versões mais recentes das duas distribuições do RTAI e Xenomai. No
caso do RTAI, a versão \ing{magma} foi baixada diretamente do site \cite{RTAI},
utilizando o sistema de controle de versão \ing{CVS}. Para o Xenomai, utilizou-se a
versão 2.4-rc5 disponível desde outubro 2007 \cite{Xenomai}.

Para estas duas plataformas, os diferentes testes de latências fornecidos foram
utilizados, dando resultados de menos de $10 \mu s$ no pior caso para a latência de
interrupção, conforme os padrões da arquitetura Intel Pentium 4. Observa-se que, em
ambas plataformas, desabilitou-se as interrupções de gerenciamento do sistema
(\ing{SMI}), conforme as recomendações dos desenvolvedores \cite{RTAI,
  Xenomai}. Isto permitiu cancelar uma latência da ordem de $2.5ms$ que aparecia nos
testes periodicamente a cada 32 segundos. No caso do Linux e de PREEMP-RT, as
interrupções de gerenciamento do sistema não foram desabilitadas. No entanto, não se
observou nenhuma latência da ordem de $2.5ms$ nos experimentos relativos a estas duas
plataformas. Provavelmente, porque a interrupção periódica de SMI aconteceu num
intervalo de tempo sem medida.

Em relação ao \ing{patch} PREEMPT-RT, ele tem evoluído rapidamente no decorrer do
seus dois anos de vida. Notadamente, desde a versão 2.6.21, o \kernell Linux
disponibiliza temporizadores de alta precisão para as arquiteturas x86, ARM e PPC, o
que permite ao \ing{patch} \preemptt de trabalhar com resolução da ordem do $\mu s$
(ver seção \ref{sec:preemptRT}) no escalonamento de tarefas. Portanto, utilizou-se a
versão estável do \kernell em dezembro de 2007, isto é, a versão 2.6.23.9.

\subsubsection{Linux e \preempt}

\begin{figure}%
  \centering
  \subfloat[][Os triângulos vermelhos correspondem aos piores casos.]{%
    \label{fig:klight1}%
    {\scalebox{1}{\input{fig/klight1}}}}\\
  \vspace{10pt}%
  \subfloat[][Os piores casos são representados no valor $15 \mu s$.]{%
    \label{fig:klight2}%
    {\scalebox{1}{\input{fig/klight2}}}}%
  \caption[Latência de interrupção do Kernel Linux]{Latência de interrupção do
    \kernell Linux 2.6.19.7, opção \ing{Low-Latency}. As figuras
    \subref{fig:klight1} e \subref{fig:klight2} representam a mesma execução.  A
    freqüência de interrupção de $20 Hz$ e os dois estresses (60 aberturas e
    fechamento de sessão \cod{ssh}) são aplicados nos instantes 10s e 40s.  Na
    figura \subref{fig:klight2}, os piores casos são mostrados no valor $15 \mu s$ para
    deixar os detalhes das demais medidas aparecer.}
%    \subref{fig:ex3-d} describes the last sub-float.}%
  \label{fig:klight}%
\end{figure}

\begin{figure}%
  \centering
  \subfloat[Os triângulos vermelhos correspondem aos piores casos.]{%
    \label{fig:preempt1}%
    {\scalebox{1}{\input{fig/preempt1}}}}\\
  \vspace{10pt}%
  \subfloat[][Os piores casos são representados no valor $15 \mu s$.]{%
    \label{fig:preempt2}%
    {\scalebox{1}{\input{fig/preempt2}}}}%
  \caption[Latência de interrupção de \preemptt]{Latência de interrupção do
    \kernell Linux 2.6.23.9, com o \ing{patch} \preemptt. As figuras
    \subref{fig:preempt1} e \subref{fig:preempt2} representam a mesma execução.  A
    freqüência de interrupção de $20 Hz$ e os dois estresses (60 aberturas e
    fechamento de sessão \cod{ssh}) são aplicados nos instantes 10s e 40s.  Na
    figura \subref{fig:preempt2}, os piores casos são mostrados no valor $15 \mu s$
    para deixar os detalhes das demais medidas aparecer.}
  \label{fig:preempt}%
\end{figure}

A figura \ref{fig:klight} apresenta as latências de interrupção observadas para o
\kernell Linux padrão. Durante os dois períodos de $10 s$ nos quais o estresse
\cod{ssh} é aplicado, os piores casos de latência, representados pelos triângulos
vermelhos na figura \ref{fig:klight1}, chegam quase a $10 ms$.  No detalhe da figura
\ref{fig:klight2}, na qual os piores casos são representados no valor arbitrário de
$15 \mu s$, percebe-se que na ausência de estresse, os tempos de latências são
bastante estáveis, abaixo de $10 \mu s$, em acordo com valores encontrados na
literatura \cite{Proctor01, Rostedt07, Siro07}. Durante a aplicação dos estresses, a
latência da maioria dos eventos aumenta apenas de $1 \mu s$. Alguns eventos isolados
chegam a atingir até 13 $\mu s$ de latência, enquanto, nos piores casos, a latência
atingi quase 1000 vezes o caso médio sem estresse.

Resultados similares foram obtidos com \preemptt como pode ser observado
nas figuras \ref{fig:preempt1} e \ref{fig:preempt2}. Esta semelhança era
de se esperar, já que o código da camada de rede do Linux é bastante otimizado, e que,
conseqüentemente, as melhorias trazidas por \preemptt não afetam as características 
temporal desta camada.

No caso do Linux, $6$ eventos tiveram uma latência superior a $20 \mu s$ e no
\preemptt foram 11 eventos similares observados.  Portanto, apesar da maioria dos
eventos - mais de 400 ao total nos dois períodos de estresse - não sofrer latência
superior a $14 \mu s$, pode-se concluir que a existência de latências de quase $10ms$
nos piores casos observados inviabilizam a utilização destas duas plataformas no
contexto de sistema de tempo real crítico.


\subsubsection{RTAI e Xenomai}

Para os experimentos com RTAI e Xenomai, foi mencionado na seção \ref{sec:dispExp}
que a transferência dos dados da memória do \kernell para o sistema de arquivo foi
realizada com os canais \ing{RT-FIFO} proporcionados pela API destas duas
plataformas. Apesar das garantias ofertas pela implementação destas plataformas,
considerou-se a possibilidade que o acesso assíncrono aos canais \cod{RT-FIFO} por
um processo usuário poderia interferir nas medidas. Portanto, realizou-se os
experimentos com duas configurações diferentes. Na primeira, os canais foram
consultados entre cada escrita na porta paralela e na segunda, o acesso só aconteceu
a cada 20 escrita na porta paralela.  Em ambos os casos, a freqüência de escrita na
porta paralela era de $20 Hz$.

Os resultados destes dois modos de operação são apresentados nas figuras
\ref{fig:rtai} para RTAI e \ref{fig:xeno} para Xenomai. Constata-se que os eventos
extremos são mais raros e tem valores menores que no caso do Linux e do
\preempt. Com RTAI, observou-se um evento extremo de $165 \mu s$ na primeira
configuração do experimento. Nos dois outros modos, um evento extremo isolado também
aconteceu, com a mesma ordem de grandeza.

Com o Xenomai, vários experimentos repetidos na primeira configuração não permitiram
de observar evento extremo algum. No entanto, com o segundo modo experimental, no
qual a leitura do canal \cod{RT-FIFO} foi realizada com uma freqüência menor,
piores casos da mesma ordem de grandeza que no RTAI foram observados.

\begin{figure}%
  \centering
  \subfloat[O triângulo vermelho corresponde a um pior caso isolado (de $165.3 \mu s$)]{%
    \label{fig:rtai2}%
    {\scalebox{1}{\input{fig/rtai2}}}}\\
  \vspace{10pt}%
  \subfloat[][Média sobre 20 eventos.]{%
    \label{fig:rtaiM2}%
    {\scalebox{1}{\input{fig/rtaiM2}}}}%
  \caption[Latência de interrupção do RTAI]{Latência de interrupção do \kernell
    Linux 2.6.19.7, com o \ing{patch} RTAI ``magma''. As figuras \subref{fig:rtai2}
    e \subref{fig:rtaiM2} representam execuções na freqüência de interrupção de $20
    Hz$. Os dois estresses (60 aberturas e fechamento de sessão \cod{ssh}) são
    aplicados nos instantes 10s e 40s.  Na figura \subref{fig:rtai2}, o pior caso é
    mostrado no valor $15 \mu s$ para deixar os detalhes das demais medidas
    aparecer. Na figura \subref{fig:rtaiM2}, o canal RT-FIFO é consultado a cada 20
    interrupções e a média correspondente é calculada.}
  \label{fig:rtai}%
\end{figure}

\begin{figure}%
  \centering
  \subfloat[Valores instantâneos.]{%
    \label{fig:xeno1}%
    {\scalebox{1}{\input{fig/xeno1}}}}\\
  \vspace{10pt}%
  \subfloat[][Média sobre 20 eventos.]{%
    \label{fig:xenoM1}%
    {\scalebox{1}{\input{fig/xenoM1}}}}%
  \caption[Latência de interrupção do Xenomai]{Latência de interrupção do \kernell
    Linux 2.6.19.7, com o \ing{patch} Xenomai 2.4-rc5. As figuras \subref{fig:xeno1}
    e \subref{fig:xenoM1} representam execuções na freqüência de interrupção de $20
    Hz$. Os dois estresses (60 aberturas e fechamento de sessão \cod{ssh}) são
    aplicados nos instantes 10s e 40s. Na figura \subref{fig:xenoM1}, o canal
    RT-FIFO é consultado a cada 20 interrupções e a média correspondente é
    calculada.}
  \label{fig:xeno}%
\end{figure}

Em conclusão destes experimentos, considerou-se que as plataformas Linux e \preemptt
não podiam dar as garantias temporais necessárias para a implementação do protocolo
\doris. Apesar de não constituir um conjunto suficiente de avaliação, os resultados
com as plataformas RTAI e Xenomai mostraram que estas plataformas tem um
comportamento similares em que diz respeito a latência de interrupção e que elas são
mais determinísticas que Linux e \preempt. As ocorrências de valores de latências
altas não ultrapassaram $200 \mu s$ e aconteceram numa freqüência máxima 
de uma vez em 400 eventos. Do ponto de visto da implementação do protocolo 
\doris, estes resultados confirmaram o ganho significativo de se trabalhar com 
as plataformas RTAI e Xenomai. No entanto, a existência de piores casos 
demonstra a necessidade de utilizar mecanismo de tolerância para 
manter as garantias do protocolo de comunicação, apesar destes eventos isolados.

Observa-se também que os experimentos foram realizadas numa
arquitetura especifica e que resultados quantitativamente diferentes teriam
provavelmente sido encontradas em outras configurações de máquinas. No entanto,
os resultados obtidos aqui são qualitativamente consistente com os resultados
apresentados em trabalhos similares \cite{McKenney05, Siro07, Dozio03}.

Além das medidas de interrupção, medidas de latências de escalonamento e de tempos
de execução são mostradas nas figuras \ref{fig:latEscal}. Estas medidas foram
realizadas com a metodologia descrita na seção \label{sec:dispExp}. A latência de
escalonamento corresponde ao tempo que passa entre a execução do tratador de
interrupção e o instante no qual a tarefa $T$ suspensa começa a executar. O tempo de
execução corresponde ao tempo do qual $T$ precisa para criar um pacote Ethernet de
64 bytes e transferi-lo para a placa de rede. Na ausência de estresse, observa-se na
figura \ref{fig:latEscal} que estes tempos são estável em ambas plataformas. No caso
do RTAI, observa-se que a latência de escalonamento é da ordem de $1 \mu s$,
enquanto para Xenomai, ela é da ordem de $4 \mu s$.  Esta diferença se deve aos
modelos de tarefas diferentes nestas duas plataformas. Como foi visto na seção
\ref{sec:adeos}, Xenomai privilegia a integração com o modo usuário do Linux e uma
das conseqüências deste modelo de desenvolvimento é a existência de uma sobrecarga
na troca de contexto de uma tarefa \cite{Gerum05}.

\begin{figure}%
  \centering
  \subfloat[Latências do RTAI]{%
    \label{fig:rtaiEsc}%
    {\scalebox{0.9}{\input{fig/rtaiEsc}}}}\\
  \vspace{20pt}
  \subfloat[Latências do Xenomai]{%
    \label{fig:xenoEsc}%
    {\scalebox{0.9}{\input{fig/xenoEsc}}}}\\
  \caption[Latência de interrupção, de escalonamento e de execução do RTAI e do
  Xenomai]{Latência de interrupção de escalonamento e de execução do Kernel Linux
    versão 2.6.19.7, com o \ing{patch} $RTAI$ e com o \ing{patch} Xenomai. As
    figuras \subref{fig:rtaiEsc} e \subref{fig:xenoEsc} apresentam as três
    latências, na forma de histogramas sobreposto um em cima do outro.  A base
    coresponde a latência de interrupção, a caixa do meio, a latência de
    escalonamento e a caixa de cima a latência de execução. Em ambos experimentos, a
    freqüência de interrupção é $20 Hz$ e o canal RT-FIFO é consultado e as médias
    correspondentes calculadas a cada 20 eventos. Os dois estresses (60 aberturas e
    fechamento de sessão \cod{ssh}) são aplicados nos instantes 10s e 40s.}
  \label{fig:latEscal}%
\end{figure}

Para observar o efeito do estresse sobre a latência de escalonamento e o tempo de
execução da tarefa $T$, a figura \ref{fig:stress} apresenta o detalhe das medidas
destes dois valores correspondendo aos experimentos das figuras
\ref{fig:rtai}\subref{fig:rtai2} e \ref{fig:xeno}\subref{fig:xeno1}.  Constata-se
que as duas plataformas comportam-se de forma bastante similares, com um aumento de
aproximadamente $4 \mu s$ na latência de interrupção e de $2$ a $3 \mu s$ no tempo
de execução. O primeiro aumento corresponde provavelmente ao tratamento de uma (ou
duas nos piores casos) interrupção da placa de rede, devida ao estresse. A segunda,
por ser mais espalhadas e ter valores menores, corresponde provavelmente a
atualização da memória tampão.

\begin{figure}%
  \centering
  \subfloat[][RTAI]{%
    \label{fig:rtaiStress}%
    {\scalebox{1}{\input{fig/rtaiStress}}}}%
   \hspace{14pt}%
  \subfloat[][Xenomai]{%
    \label{fig:xenoStress}%
    {\scalebox{1}{\input{fig/xenoStress}}}}%
%   \hspace{14pt}%
%   \subfloat[][Média sobre 50 eventos, freqüência de $1000 Hz$.]{%
%     \label{fig:xenoF1}%
%     {\scalebox{0.6}{\input{fig/xenoF1}}}}%
  \caption[Latência de escalonamento e de execução de RTAI e Xenomai]{Latência de
    escalonamento e tempo de execuções do Kernel Linux 2.6.19.7, com RTAI e com
    Xenomai. As figuras \subref{fig:rtaiStress} e \subref{fig:xenoStress}
    representam detalhes das figuras \ref{fig:rtai}\subref{fig:rtai2} e
    \ref{fig:xeno}\subref{fig:xeno1}.}
  \label{fig:stress}%
\end{figure}








A interpretação proposta aqui para os resultados relativos ao estresse UDP é a
seguinte.  Quando a placa de rede recebe um pacote Ethernet, ela gera uma
interrupção para informar o processador. Este eventualmente executa o tratador
associado a esta interrupção. Mas, se um novo pacote cheguar antes do fim da sua
execução, o tratador poderia ser preemptado por uma outra execução dele mesmo.  Para
prevenir esta eventualidade, foi visto na seção \label{sec:interrupt} que o \kernell
padrão desabilita as interrupções durante a execução de um tratador de
interrupção. Além disso, durante a execução do tratador, quando o \kernell percebe
que vários pacotes estão esperando na memória tampão da placa, uma otimização da
camada de rede permite que estes vários pacotes sejam recebidos, sem esperar novas
interrupções. Estas operações acumuladas podem explicar que as interrupções sejam
desabilitadas para tempos mais longo que o tempo de recepção de um pacote só.

\begin{figure}[!hbt]
  %\hfill
  %\vspace{0.2in}
  \begin{minipage}[!t]{\textwidth}
    \begin{center}  
      \centerline{\resizebox{0.8\linewidth}{!}{\input{fig/irqKern}}}
      \caption{Latência de interrupção do \kernell Linux}
      \label{fig:irqKern}
    \end{center}
  \end{minipage}
  %\hfill
  \\
  \vspace{.4in}
  \begin{minipage}[!t]{\textwidth}
    \begin{center}  
      \centerline{\resizebox{0.8\linewidth}{!}{\input{fig/irqKernMean}}}
      \caption{Latência de interrupção do \kernell Linux (média sobre 10 valores)}
      \label{fig:irqKernMean}
    \end{center}
  \end{minipage}
  %\hfill
\end{figure}

\begin{figure}[!hbt]
  %\hfill
  %\vspace{0.2in}
  \begin{minipage}[!t]{\textwidth}
    \begin{center}  
      \centerline{\resizebox{0.8\linewidth}{!}{\input{fig/irqXeno}}}
      \caption{Latência de interrupção do Xenomai}
      \label{fig:irqXeno}
    \end{center}
  \end{minipage}
  %\hfill
  \\
  \vspace{.4in}
  \begin{minipage}[!t]{\textwidth}
    \begin{center}  
      \centerline{\resizebox{0.8\linewidth}{!}{\input{fig/irqXenoMean}}}
      \caption{Latência de interrupção do Xenomai (média sobre 10 valores)}
      \label{fig:irqXenoMean}
    \end{center}
  \end{minipage}
  %\hfill
\end{figure}

\begin{figure}[hbt]
  \index{fig!irqXeno}
  \centering
  \input{fig/irqXeno}
  \caption{Latência de interrupção do Xenomai}
  \label{fig:irqXeno}
\end{figure}

\begin{figure}[hbt]
  \index{fig!irqXenoMean}
  \centering
  \input{fig/irqXenoMean}
  \caption{Latência de interrupção do Xenomai  (média sobre 10 valores)}
  \label{fig:irqXenoMean}
\end{figure}

\begin{figure}[hbt]
  \index{fig!irqRTAI}
  \centering
  \input{fig/irqRTAI}
  \caption{Latência de interrupção do RTAI}
  \label{fig:irqRTAI}
\end{figure}




  \begin{figure}
    \begin{center}
      \input{fig/realSemStr}
    \end{center}
  \end{figure}

  \begin{figure}
    \begin{center}
      \input{fig/diffSemStr}
    \end{center}
  \end{figure}


  \begin{figure}
    \begin{center}
      \input{fig/realComStr}
    \end{center}
  \end{figure}

  \begin{figure}
    \begin{center}
      \input{fig/diffComStr}
    \end{center}
  \end{figure}

\end{comment}

